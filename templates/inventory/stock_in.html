{% extends "base.html" %}

{% block title %}รับสินค้าเข้า (Batch) - GoFresh StockPro{% endblock %}

{% block head_extra %}
<meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover">

<style>
    /* CSS ที่จำเป็นสำหรับการจัด layout และ component เฉพาะของหน้านี้ */
    #product_search_input_batch_mobile {
        margin-bottom: 0.5rem;
    }

    #product_browse_grid_batch_mobile {
        display: grid;
        grid-template-columns: repeat(auto-fill, minmax(120px, 1fr));
        gap: 0.75rem;
        max-height: 320px;
        overflow-y: auto;
        background-color: transparent; /* พื้นหลังโปร่งใส */
        padding: 0.75rem;
        border-radius: var(--bs-border-radius);
        border: 1px solid var(--hitech-border, #dee2e6);
        margin-top: 0.5rem;
    }

    .product-card-mobile {
        background-color: var(--hitech-surface, #ffffff);
        border: 1px solid var(--hitech-border, #dee2e6);
        border-radius: var(--bs-border-radius-sm, 0.25rem);
        padding: 0.75rem 0.5rem;
        font-size: 0.85rem;
        text-align: center;
        cursor: pointer;
        transition: transform 0.15s ease-out, box-shadow 0.15s ease-out, border-color 0.2s ease;
        display: flex;
        flex-direction: column;
        justify-content: space-between;
        min-height: 90px;
    }
    .product-card-mobile:hover:not(.selected) { /* Hover effect for unselected cards */
        transform: translateY(-2px);
        border-color: var(--hitech-accent, #00b359);
        box-shadow: 0 4px 12px rgba(var(--hitech-accent-rgb, 0, 179, 89), 0.15);
    }
    .product-card-mobile.card-selected-animation-mobile { /* Animation ตอนคลิก */
        transform: scale(0.95) translateY(0);
    }
    .product-card-mobile.selected { /* สไตล์สำหรับสินค้าที่ถูกเลือกค้างไว้ */
        border-color: var(--hitech-success, #198754) !important;
        box-shadow: 0 0 0 0.2rem rgba(var(--hitech-success-rgb, 25, 135, 84), 0.3);
        background-color: rgba(var(--hitech-success-rgb, 25, 135, 84), 0.05);
        transform: translateY(0); /* No lift when selected */
    }
    .product-card-mobile .name {
        font-weight: 600;
        margin-bottom: 0.25rem;
        color: var(--hitech-text-primary);
        font-size: 0.9em;
        line-height: 1.3;
        display: -webkit-box;
        -webkit-line-clamp: 2;
        line-clamp: 2;
        -webkit-box-orient: vertical;
        overflow: hidden;
        text-overflow: ellipsis;
        min-height: 2.6em;
    }
    .product-card-mobile .sku {
        font-size: 0.8em;
        color: var(--hitech-text-secondary);
        word-break: break-all;
    }

    #selected_products_list_mobile .list-group-item {
        padding: 0.6rem 0.75rem;
        font-size: 0.9rem;
        background-color: var(--hitech-surface-hover);
    }
    #selected_products_list_mobile .product-info { margin-right: auto; }
    #selected_products_list_mobile .remove-item-btn {
         padding: 0.1rem 0.4rem;
         line-height: 1;
    }

    .item-detail-card-mobile {
        background-color: var(--hitech-surface);
        border: 1px solid var(--hitech-border);
        margin-bottom: 1rem;
        padding: 1rem;
        border-radius: var(--bs-border-radius);
        box-shadow: var(--bs-box-shadow-sm);
    }
    .item-detail-card-mobile .card-title-mobile {
        font-size: 1rem;
        font-weight: 600;
        margin-bottom: 0.75rem;
        color: var(--hitech-accent);
    }
    .item-detail-card-mobile .form-floating > label {
        font-size: 0.85rem;
    }
    .item-detail-card-mobile .calculated-expiry-text {
        font-size: 0.8rem;
        color: var(--hitech-text-secondary);
    }
    .batch-date-apply-section {
        background-color: var(--hitech-surface-hover);
        border-radius: var(--bs-border-radius-sm);
    }

    .stockin-footer-actions {
        position: sticky;
        bottom: 0;
        left: 0;
        right: 0;
        background-color: var(--hitech-surface, #ffffff);
        padding: 0.75rem 1rem;
        border-top: 1px solid var(--hitech-border, #dee2e6);
        box-shadow: 0 -2px 10px rgba(0,0,0,0.08);
        z-index: 1020;
        display: flex;
        gap: 0.5rem;
    }
    .stockin-footer-actions .btn {
        flex-grow: 1;
        font-weight: 500;
    }

    @media (min-width: 768px) {
        .stockin-main-content-flex {
            display: flex;
            gap: 1.5rem;
        }
        .stockin-phase1-col, .stockin-phase2-col {
            flex: 1;
        }
        .stockin-footer-actions {
            justify-content: flex-end;
        }
        .stockin-footer-actions .btn {
            flex-grow: 0;
            min-width: 150px;
        }
    }

    .hidden { display: none !important; }

    /* --- CSS สำหรับปรับสีไอคอนปฏิทิน --- */
    input[type="date"]::-webkit-calendar-picker-indicator {
        opacity: 1;
        cursor: pointer;
        background-image: url('data:image/svg+xml;utf8,<svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="%2300b359" class="bi bi-calendar3" viewBox="0 0 16 16"><path d="M14 0H2a2 2 0 0 0-2 2v12a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V2a2 2 0 0 0-2-2M1 3.857C1 3.384 1.448 3 2 3h12c.552 0 1 .384 1 .857v10.286c0 .473-.448.857-1 .857H2c-.552 0-1-.384-1-.857V3.857z"/><path d="M6.5 7a1 1 0 1 0 0-2 1 1 0 0 0 0 2m3 0a1 1 0 1 0 0-2 1 1 0 0 0 0 2m3 0a1 1 0 1 0 0-2 1 1 0 0 0 0 2m-9 3a1 1 0 1 0 0-2 1 1 0 0 0 0 2m3 0a1 1 0 1 0 0-2 1 1 0 0 0 0 2m3 0a1 1 0 1 0 0-2 1 1 0 0 0 0 2m3 0a1 1 0 1 0 0-2 1 1 0 0 0 0 2m-9 3a1 1 0 1 0 0-2 1 1 0 0 0 0 2m3 0a1 1 0 1 0 0-2 1 1 0 0 0 0 2m3 0a1 1 0 1 0 0-2 1 1 0 0 0 0 2"/></svg>');
        width: 1em;
        height: 1em;
    }
    input[type="date"].form-control {
        color: var(--bs-body-color);
    }
    /* --- END CSS ไอคอนปฏิทิน --- */
</style>
{% endblock %}

{% block content %}
<div class="d-flex justify-content-between align-items-center mb-3">
    <h1><i class="bi bi-box-arrow-in-down me-2 text-accent"></i>รับสินค้าเข้า (Batch)</h1>
</div>
{% include '_alert_messages.html' %}

<form method="post" id="batchStockInFormMobile" action="{{ request.app.url_path_for('ui_process_stock_in_details_for_review') }}">
    <div class="stockin-main-content-flex">
        <div class="col-12 col-md-5 stockin-phase1-col">
            <div class="card mb-4">
                <div class="card-header">
                    <h5 class="mb-0">1. เลือกสินค้าเข้ารายการ</h5>
                </div>
                <div class="card-body">
                    <div class="mb-3">
                        <div class="form-floating">
                            <input type="text" class="form-control" id="product_search_input_batch_mobile" placeholder="สแกน SKU/Barcode หรือพิมพ์ชื่อสินค้า">
                            <label for="product_search_input_batch_mobile">สแกน/ค้นหา/พิมพ์ชื่อสินค้า</label>
                        </div>
                        <div id="product_search_error_batch_mobile" class="text-danger small mt-1"></div>
                    </div>
                    <div class="mb-3">
                        <div class="form-floating">
                            <select class="form-select" id="category_select_batch_mobile" aria-label="เลือกหมวดหมู่">
                                <option value="">-- ทุกหมวดหมู่ --</option>
                                {% for category in categories %}<option value="{{ category.id }}">{{ category.name }}</option>{% endfor %}
                            </select>
                            <label for="category_select_batch_mobile">หรือเลือกจากหมวดหมู่:</label>
                        </div>
                    </div>
                    <div id="product_browse_grid_batch_mobile">
                        <p class="text-muted small p-2" id="product_grid_placeholder_batch_mobile" style="grid-column: 1 / -1;">เลือกหมวดหมู่หรือค้นหา...</p>
                    </div>

                    <hr class="my-3">
                    <h6>สินค้าใน Batch (<span id="selected_item_count_mobile">0</span>):</h6>
                    <ul class="list-group list-group-flush mb-0" id="selected_products_list_mobile" style="max-height: 200px; overflow-y: auto;">
                        <li class="list-group-item text-muted small" id="no_selected_items_placeholder_mobile">ยังไม่มีสินค้า</li>
                    </ul>
                </div>
            </div>
        </div>

        <div class="col-12 col-md-7 stockin-phase2-col">
            <div class="card mb-4">
                <div class="card-header">
                    <h5 class="mb-0">2. กรอกรายละเอียด Batch และรายการสินค้า</h5>
                </div>
                <div class="card-body">
                    <div class="mb-3 form-floating">
                        <select class="form-select" id="location_id_batch_mobile" name="location_id" required aria-label="เลือกสถานที่">
                            <option value="">-- เลือกสถานที่ --</option>
                            {% for location in locations %}<option value="{{ location.id }}">{{ location.name }}</option>{% endfor %}
                        </select>
                        <label for="location_id_batch_mobile">สถานที่จัดเก็บ <span class="text-danger">*</span></label>
                    </div>
                    <div class="mb-3 form-floating">
                         <textarea class="form-control" id="batch_notes_mobile" name="batch_notes" style="height: 70px;" placeholder="หมายเหตุรวม"></textarea>
                         <label for="batch_notes_mobile">หมายเหตุรวม (ถ้ามี)</label>
                    </div>
                    
                    <div class="batch-date-apply-section p-3 mb-3">
                        <div class="row g-2 align-items-end">
                            <div class="col-sm-7 mb-2 mb-sm-0 form-floating">
                                <input type="date" class="form-control" id="batch_default_production_date_mobile" placeholder=" ">
                                <label for="batch_default_production_date_mobile">วันผลิตเริ่มต้น (ทั้งหมด):</label>
                            </div>
                            <div class="col-sm-5">
                                <button type="button" class="btn btn-outline-primary btn-sm w-100 py-2" id="apply_prod_date_all_btn_mobile">ใช้กับทั้งหมด</button>
                            </div>
                        </div>
                         <div class="form-check form-switch mt-2 mb-2">
                             <input class="form-check-input" type="checkbox" role="switch" id="toggle_expiry_input_all_switch_mobile">
                             <label class="form-check-label small" for="toggle_expiry_input_all_switch_mobile">กรอกวันหมดอายุโดยตรง (แทนการคำนวณ)</label>
                        </div>
                        <div class="row g-2 align-items-end hidden" id="batch_default_expiry_date_row_mobile">
                            <div class="col-sm-7 mb-2 mb-sm-0 form-floating">
                                <input type="date" class="form-control" id="batch_default_expiry_date_mobile" placeholder=" ">
                                <label for="batch_default_expiry_date_mobile">วันหมดอายุเริ่มต้น (ทั้งหมด):</label>
                            </div>
                            <div class="col-sm-5">
                                <button type="button" class="btn btn-outline-primary btn-sm w-100 py-2" id="apply_exp_date_all_btn_mobile">ใช้กับทั้งหมด</button>
                            </div>
                        </div>
                    </div>
                    <hr class="mt-4">
                    <div id="batch_items_details_container_mobile">
                        <p class="text-muted text-center p-3" id="details_placeholder_batch_mobile">เลือกสินค้าในขั้นตอนที่ 1 ก่อน เพื่อกรอกรายละเอียด</p>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <div class="stockin-footer-actions">
         <button type="button" class="btn btn-outline-secondary" id="show_phase1_btn_mobile"> <i class="bi bi-list-ul"></i> เลือกสินค้า (<span class="selected_item_count_display">0</span>) </button>
         <button type="button" class="btn btn-primary" id="show_phase2_btn_mobile" disabled> <i class="bi bi-pencil-square"></i> กรอกรายละเอียด </button>
         <button type="submit" class="btn btn-success" id="review_batch_btn_mobile" disabled>
            <i class="bi bi-check-circle-fill"></i> ตรวจสอบ Batch
        </button>
    </div>
</form>

<template id="item_detail_card_template_mobile">
    <div class="item-detail-card-mobile" data-product-id-mobile="PRODUCT_ID_VAL">
        <h6 class="card-title-mobile">
            <span class="product-name-display-mobile">Product Name</span> 
            <small class="text-muted product-sku-display-mobile">(SKU: ...)</small>
        </h6>
        <input type="hidden" name="items[INDEX][product_id]" class="item-product-id-mobile">
        <input type="hidden" class="item-shelf-life-mobile">
        
        <div class="form-floating mb-2">
            <input type="number" min="0.01" step="any" class="form-control item-quantity-mobile" name="items[INDEX][quantity]" required id="item_INDEX_quantity_mobile" placeholder="จำนวน">
            <label for="item_INDEX_quantity_mobile">จำนวน (กิโลกรัม) <span class="text-danger">*</span></label>
        </div>
        
        <div class="item-production-date-group-mobile hidden mb-2 form-floating">
            <input type="date" class="form-control item-production-date-mobile" name="items[INDEX][production_date]" id="item_INDEX_prod_date_mobile" placeholder=" ">
            <label for="item_INDEX_prod_date_mobile">วันผลิต (<span class="item-shelf-life-display-mobile"></span>)</label>
            <div class="calculated-expiry-text small mt-1 text-muted"></div>
        </div>
        <div class="item-expiry-date-group-mobile hidden mb-2 form-floating">
            <input type="date" class="form-control item-expiry-date-mobile" name="items[INDEX][expiry_date]" id="item_INDEX_exp_date_mobile" placeholder=" ">
            <label for="item_INDEX_exp_date_mobile">วันหมดอายุ</label>
        </div>
    </div>
</template>

{% if form_data_raw %}
<script id="form_data_raw_script_mobile" type="application/json">
    {{ form_data_raw | tojson | safe }}
</script>
{% endif %}

{% endblock %}

{% block scripts_extra %}
<script>
document.addEventListener('DOMContentLoaded', function() {
    const phase1Col = document.querySelector('.stockin-phase1-col');
    const phase2Col = document.querySelector('.stockin-phase2-col');
    const showPhase1Btn = document.getElementById('show_phase1_btn_mobile');
    const showPhase2Btn = document.getElementById('show_phase2_btn_mobile');
    const reviewBatchBtnMobile = document.getElementById('review_batch_btn_mobile');
    
    const selectedItemCountMobileEl = document.getElementById('selected_item_count_mobile');
    const selectedItemCountInButtonEls = document.querySelectorAll('.selected_item_count_display');

    const isMobileView = () => window.innerWidth < 768;

    function showPhase(phaseNum) {
        const footerActions = document.querySelector('.stockin-footer-actions');
        if (isMobileView()) { 
            if (phase1Col) phase1Col.style.display = (phaseNum === 1) ? 'block' : 'none';
            if (phase2Col) phase2Col.style.display = (phaseNum === 2) ? 'block' : 'none';
            
            if (showPhase1Btn) {
                showPhase1Btn.classList.toggle('active', phaseNum === 1);
                showPhase1Btn.classList.toggle('btn-info', phaseNum === 1); 
                showPhase1Btn.classList.toggle('btn-outline-secondary', phaseNum !== 1);
                showPhase1Btn.classList.remove('hidden');
            }
            if (showPhase2Btn) {
                showPhase2Btn.classList.toggle('active', phaseNum === 2);
                showPhase2Btn.classList.toggle('btn-info', phaseNum === 2); 
                showPhase2Btn.classList.toggle('btn-primary', phaseNum !== 2);
                showPhase2Btn.classList.remove('hidden');
            }
            if (reviewBatchBtnMobile) reviewBatchBtnMobile.classList.toggle('hidden', phaseNum === 1);

        } else { 
            if (phase1Col) phase1Col.style.display = 'block';
            if (phase2Col) phase2Col.style.display = 'block';
            if (showPhase1Btn) showPhase1Btn.classList.add('hidden'); 
            if (showPhase2Btn) showPhase2Btn.classList.add('hidden');
            if (reviewBatchBtnMobile) reviewBatchBtnMobile.classList.remove('hidden'); 
        }
        if (footerActions && !isMobileView()){
             footerActions.classList.add('d-md-flex', 'justify-content-end'); 
             footerActions.classList.remove('justify-content-center'); 
        } else if (footerActions && isMobileView()){
            footerActions.classList.remove('d-md-flex', 'justify-content-end', 'justify-content-center');
        }
        updateButtonStates(); 
    }
    
    if(showPhase1Btn && showPhase2Btn){ 
        showPhase1Btn.addEventListener('click', () => showPhase(1));
        showPhase2Btn.addEventListener('click', () => {
            if(selectedProducts.size === 0 && isMobileView()) { 
                alert("กรุณาเลือกสินค้าอย่างน้อย 1 รายการก่อนไปขั้นตอนถัดไป");
                return;
            }
            if (!detailFormRendered || (batchItemsDetailsContainer && selectedProducts.size > 0 && batchItemsDetailsContainer.querySelectorAll('.item-detail-card-mobile').length !== selectedProducts.size) ) { 
                renderAllDetailFormsMobile();
            }
            showPhase(2);
        });
    }
    
    const productSearchInput = document.getElementById('product_search_input_batch_mobile');
    const productSearchError = document.getElementById('product_search_error_batch_mobile');
    const categorySelect = document.getElementById('category_select_batch_mobile');
    const productBrowseGrid = document.getElementById('product_browse_grid_batch_mobile');
    const productGridPlaceholder = document.getElementById('product_grid_placeholder_batch_mobile');
    
    const selectedProductsListEl = document.getElementById('selected_products_list_mobile');
    const noSelectedItemsPlaceholder = document.getElementById('no_selected_items_placeholder_mobile');
    
    const batchItemsDetailsContainer = document.getElementById('batch_items_details_container_mobile');
    const detailsPlaceholder = document.getElementById('details_placeholder_batch_mobile');
    const itemDetailCardTemplate = document.getElementById('item_detail_card_template_mobile');
    const locationIdBatchSelect = document.getElementById('location_id_batch_mobile');
    
    const batchDefaultProdDateInput = document.getElementById('batch_default_production_date_mobile');
    const applyProdDateAllBtn = document.getElementById('apply_prod_date_all_btn_mobile');
    const batchDefaultExpDateInput = document.getElementById('batch_default_expiry_date_mobile');
    const applyExpDateAllBtn = document.getElementById('apply_exp_date_all_btn_mobile');
    const toggleExpiryInputAllSwitch = document.getElementById('toggle_expiry_input_all_switch_mobile');
    const batchDefaultExpiryDateRow = document.getElementById('batch_default_expiry_date_row_mobile');
    const batchStockInForm = document.getElementById('batchStockInFormMobile');

    let selectedProducts = new Map(); 
    let detailFormRendered = false;
    let itemDetailIndexCounter = 0; 

    function updateButtonStates() {
        const count = selectedProducts.size;
        if (selectedItemCountMobileEl) {
            selectedItemCountMobileEl.textContent = count;
        }
        if (selectedItemCountInButtonEls) {
            selectedItemCountInButtonEls.forEach(el => el.textContent = count);
        }

        if (showPhase2Btn) showPhase2Btn.disabled = count === 0; 
        if (reviewBatchBtnMobile) reviewBatchBtnMobile.disabled = count === 0 || !detailFormRendered || (locationIdBatchSelect && !locationIdBatchSelect.value);
        
        if (noSelectedItemsPlaceholder) {
            if (count > 0) {
                noSelectedItemsPlaceholder.classList.add('hidden');
            } else {
                noSelectedItemsPlaceholder.classList.remove('hidden');
                if (batchItemsDetailsContainer) batchItemsDetailsContainer.innerHTML = ''; 
                if (detailsPlaceholder) detailsPlaceholder.classList.remove('hidden');
                detailFormRendered = false; 
            }
        }
    }
    
    async function fetchProductForSelectionMobile(productIdentifier) {
        if(!productSearchError) return; 
        if (!productIdentifier || productIdentifier.trim().length === 0) {
             productSearchError.textContent = 'กรุณากรอกรหัสหรือชื่อสินค้า';
             return;
        }
        productSearchError.textContent = 'กำลังค้นหา...';
        try {
            const response = await fetch(`/api/products/lookup-by-scan/${encodeURIComponent(productIdentifier.trim())}`);
            if (!response.ok) {
                const errorData = await response.json().catch(() => ({detail: `ไม่พบสินค้า (${response.status})`}));
                throw new Error(errorData.detail);
            }
            const product = await response.json();
            if (product && product.id) {
                toggleProductSelection(product); 
                productSearchError.textContent = '';
                if(productSearchInput) productSearchInput.value = '';
            } else {
                if(categorySelect) loadProductsForBrowseGridMobile(categorySelect.value, productIdentifier.trim());
                productSearchError.textContent = 'ไม่พบ SKU/Barcode, ลองค้นหาจากชื่อ';
            }
        } catch (error) {
            console.error('Product search error (mobile):', error);
            productSearchError.textContent = error.message;
            if(categorySelect) loadProductsForBrowseGridMobile(categorySelect.value, productIdentifier.trim());
        }
    }

    function toggleProductSelection(product) {
        if (!product || !product.id) return;

        const cardInGrid = productBrowseGrid ? productBrowseGrid.querySelector(`.product-card-mobile[data-product-id="${product.id}"]`) : null;
        const productDataForMap = {
            id: product.id, name: product.name || 'N/A', sku: product.sku || 'N/A',
            shelf_life_days: (product.shelf_life_days !== null && product.shelf_life_days !== undefined) ? product.shelf_life_days : null,
            barcode: product.barcode || null
        };

        if (selectedProducts.has(product.id)) {
            // --- PRODUCT IS ALREADY SELECTED: REMOVE IT ---
            selectedProducts.delete(product.id);

            if (selectedProductsListEl) {
                const listItemToRemove = selectedProductsListEl.querySelector(`li[data-product-id="${product.id}"]`);
                if (listItemToRemove) listItemToRemove.remove();
            }
            if (cardInGrid) cardInGrid.classList.remove('selected');

            if (batchItemsDetailsContainer) { 
                const detailCardToRemove = batchItemsDetailsContainer.querySelector(`.item-detail-card-mobile[data-product-id-mobile="${product.id}"]`);
                if (detailCardToRemove) detailCardToRemove.remove();
                if (batchItemsDetailsContainer.childElementCount === 0) { 
                    if(detailsPlaceholder) detailsPlaceholder.classList.remove('hidden');
                    detailFormRendered = false; 
                }
            }
        } else {
            // --- PRODUCT IS NOT SELECTED: ADD IT ---
            selectedProducts.set(product.id, productDataForMap);
            if (selectedProductsListEl) {
                const listItem = document.createElement('li');
                listItem.className = 'list-group-item d-flex justify-content-between align-items-center';
                listItem.dataset.productId = product.id;
                listItem.innerHTML = `<span class="product-info">${productDataForMap.name} (SKU: ${productDataForMap.sku})</span>
                                      <button type="button" class="btn btn-danger btn-sm remove-item-btn"><i class="bi bi-x-lg"></i></button>`;
                listItem.querySelector('.remove-item-btn').onclick = function() {
                    const productIdToRemove = parseInt(listItem.dataset.productId);
                    selectedProducts.delete(productIdToRemove);
                    listItem.remove();
                    if(productBrowseGrid){
                        const correspondingGridCard = productBrowseGrid.querySelector(`.product-card-mobile[data-product-id="${productIdToRemove}"]`);
                        if (correspondingGridCard) correspondingGridCard.classList.remove('selected');
                    }
                    if (batchItemsDetailsContainer) {
                        const detailCard = batchItemsDetailsContainer.querySelector(`.item-detail-card-mobile[data-product-id-mobile="${productIdToRemove}"]`);
                        if (detailCard) detailCard.remove();
                         if (batchItemsDetailsContainer.childElementCount === 0 ) {
                           if(detailsPlaceholder) detailsPlaceholder.classList.remove('hidden');
                           detailFormRendered = false; 
                        }
                    }
                    updateButtonStates();
                    if (selectedProducts.size === 0 && isMobileView()) showPhase(1);
                };
                selectedProductsListEl.appendChild(listItem);
            }
            if (cardInGrid) cardInGrid.classList.add('selected');
            
            if (batchItemsDetailsContainer && detailsPlaceholder) {
                detailsPlaceholder.classList.add('hidden'); 
            }
            renderSingleItemDetailCardMobile(productDataForMap, itemDetailIndexCounter++);
            if (!detailFormRendered && selectedProducts.size > 0) { 
                 detailFormRendered = true;
            }
        }
        updateButtonStates();
        if (productSearchInput) productSearchInput.value = '';
    }
    
    async function loadProductsForBrowseGridMobile(categoryId, searchQuery = null) {
        if(!productBrowseGrid || !productGridPlaceholder) return;
        productGridPlaceholder.style.display = 'none';
        productBrowseGrid.innerHTML = '<div class="col-12 text-center p-3"><div class="spinner-border spinner-border-sm text-secondary" role="status"><span class="visually-hidden">กำลังโหลด...</span></div></div>';
        
        let apiUrl = '/api/products?limit=50'; 
        if (categoryId && categoryId.trim() !== "") {
            apiUrl = `/api/products/by-category/${categoryId}/basic`;
        }
        console.log("Fetching products for grid from API URL:", apiUrl);

        try {
            const response = await fetch(apiUrl);
            if (!response.ok) {
                const errorText = await response.text();
                console.error("API Error Response Text:", errorText);
                throw new Error(`โหลดสินค้าไม่สำเร็จ: ${response.status} ${response.statusText}`);
            }
            const apiResult = await response.json();
            console.log("API Result for grid:", apiResult);

            let products = [];
            if (apiUrl.includes('/by-category/')) { 
                products = Array.isArray(apiResult) ? apiResult : [];
            } else { 
                products = Array.isArray(apiResult.items) ? apiResult.items : [];
            }
            console.log("Parsed products for grid:", products);

            productBrowseGrid.innerHTML = ''; 

            if (searchQuery && searchQuery.trim() !== "") {
                const lowerQuery = searchQuery.toLowerCase();
                products = products.filter(p =>
                    (p.name && p.name.toLowerCase().includes(lowerQuery)) ||
                    (p.sku && p.sku.toLowerCase().includes(lowerQuery)) ||
                    (p.barcode && p.barcode.toLowerCase().includes(lowerQuery))
                );
            }

            if (products.length > 0) {
                products.forEach(product => {
                    const card = document.createElement('div');
                    card.className = 'product-card-mobile'; 
                    card.dataset.productId = product.id;
                    card.innerHTML = `<div class="name">${product.name || 'N/A'}</div><div class="sku">${product.sku || 'N/A'}</div>`;
                    card.addEventListener('click', function() {
                        this.classList.add('card-selected-animation-mobile'); 
                        toggleProductSelection(product); 
                        setTimeout(() => { this.classList.remove('card-selected-animation-mobile'); }, 250);
                    });
                    if (selectedProducts.has(product.id)) {
                        card.classList.add('selected');
                    }
                    productBrowseGrid.appendChild(card);
                });
            } else { 
                if (searchQuery && searchQuery.trim() !== "") {
                    productBrowseGrid.innerHTML = '<p class="text-muted small p-2 col-12 text-center" style="grid-column: 1 / -1;">-- ไม่พบสินค้าจากคำค้นหา --</p>';
                } else if (categoryId && categoryId.trim() !== "") {
                     productBrowseGrid.innerHTML = '<p class="text-muted small p-2 col-12 text-center" style="grid-column: 1 / -1;">-- ไม่มีสินค้าในหมวดหมู่นี้ --</p>';
                } else {
                     productBrowseGrid.innerHTML = '<p class="text-muted small p-2 col-12 text-center" style="grid-column: 1 / -1;">-- ไม่พบสินค้า --</p>';
                }
            }
        } catch (error) { 
            console.error("Error in loadProductsForBrowseGridMobile:", error); 
            productBrowseGrid.innerHTML = `<p class="text-danger small p-2 col-12 text-center" style="grid-column: 1 / -1;">โหลดข้อมูลผิดพลาด: ${error.message}</p>`;
        }
    }

    function renderSingleItemDetailCardMobile(product, index) {
        if(!itemDetailCardTemplate || !batchItemsDetailsContainer) return;
        const templateContent = itemDetailCardTemplate.content.cloneNode(true);
        const cardElement = templateContent.querySelector('.item-detail-card-mobile');
        if(!cardElement) return;

        cardElement.dataset.productIdMobile = product.id;

        const nameDisplay = cardElement.querySelector('.product-name-display-mobile');
        if(nameDisplay) nameDisplay.textContent = product.name;
        const skuDisplay = cardElement.querySelector('.product-sku-display-mobile');
        if(skuDisplay) skuDisplay.textContent = `(SKU: ${product.sku})`;
        
        cardElement.querySelectorAll('[name^="items[INDEX]"]').forEach(input => {
            input.name = input.name.replace('INDEX', index);
            const fieldNameMatch = input.name.match(/\[([^\][]*)]$/); 
            if (fieldNameMatch && fieldNameMatch[1]) {
                 input.id = `item_${index}_${fieldNameMatch[1]}_mobile`;
                 const label = cardElement.querySelector(`label[for="item_INDEX_${fieldNameMatch[1]}_mobile"]`);
                 if (label) label.htmlFor = input.id;
            }
        });
        
        const prodIdInput = cardElement.querySelector('.item-product-id-mobile');
        if(prodIdInput) prodIdInput.value = product.id;
        
        const shelfLifeHiddenInput = cardElement.querySelector('.item-shelf-life-mobile');
        const shelfLifeDays = (product.shelf_life_days !== null && product.shelf_life_days !== undefined) ? product.shelf_life_days : '';
        if(shelfLifeHiddenInput) shelfLifeHiddenInput.value = shelfLifeDays;
        
        const shelfLifeDisplayElements = cardElement.querySelectorAll('.item-shelf-life-display-mobile');
        shelfLifeDisplayElements.forEach(el => {
            el.textContent = `อายุ: ${shelfLifeDays !== '' ? shelfLifeDays + ' วัน' : 'ไม่ระบุ'}`;
        });
                
        const prodDateGroup = cardElement.querySelector('.item-production-date-group-mobile');
        const expDateGroup = cardElement.querySelector('.item-expiry-date-group-mobile');
        const prodDateInput = cardElement.querySelector('.item-production-date-mobile');
        const expDateInput = cardElement.querySelector('.item-expiry-date-mobile');
        const calcExpDisplay = cardElement.querySelector('.calculated-expiry-text');

        if(prodDateInput) prodDateInput.disabled = false;
        if(expDateInput) expDateInput.disabled = false;

        function toggleDatesForItem() {
            if(!prodDateInput || !expDateInput || !prodDateGroup || !expDateGroup) return;

            const slDaysVal = shelfLifeHiddenInput ? shelfLifeHiddenInput.value : '';
            const slDays = slDaysVal !== '' && !isNaN(parseInt(slDaysVal, 10)) ? parseInt(slDaysVal, 10) : null;
            
            prodDateInput.required = false; 
            expDateInput.required = false;
            
            const useDirectExpiry = toggleExpiryInputAllSwitch ? toggleExpiryInputAllSwitch.checked : false;

            if (useDirectExpiry) {
                prodDateGroup.classList.add('hidden'); 
                expDateGroup.classList.remove('hidden');
                prodDateInput.value = ''; 
            } else if (slDays !== null && slDays >= 0) { 
                prodDateGroup.classList.remove('hidden'); 
                expDateGroup.classList.add('hidden');
                expDateInput.value = ''; 
                prodDateInput.required = true;
            } else { 
                prodDateGroup.classList.add('hidden'); 
                expDateGroup.classList.remove('hidden');
                prodDateInput.value = ''; 
            }
        }
        function calculateExpiryForItem() {
            if(!calcExpDisplay || !prodDateInput || !shelfLifeHiddenInput) return;
            
            const slDaysVal = shelfLifeHiddenInput.value;
            const slDays = slDaysVal !== '' && !isNaN(parseInt(slDaysVal, 10)) ? parseInt(slDaysVal, 10) : null;
            const prodDateStr = prodDateInput.value; 
            calcExpDisplay.textContent = '';

            if (slDays !== null && slDays >= 0 && prodDateStr) {
                 try {
                    const dateParts = prodDateStr.split('-');
                    if (dateParts.length === 3) {
                        const jsDate = new Date(Date.UTC(parseInt(dateParts[0]), parseInt(dateParts[1]) - 1, parseInt(dateParts[2])));
                        if (isNaN(jsDate.getTime())) { calcExpDisplay.textContent = 'วันที่ผลิตไม่ถูกต้อง'; return; }
                        jsDate.setUTCDate(jsDate.getUTCDate() + slDays);
                        calcExpDisplay.textContent = `~หมดอายุ: ${jsDate.toISOString().split('T')[0]}`;
                    } else { calcExpDisplay.textContent = 'รูปแบบวันผลิตไม่ถูกต้อง'; }
                } catch(e) { calcExpDisplay.textContent = 'คำนวณผิดพลาด';}
            }
        }
        toggleDatesForItem(); 
        if(prodDateInput) {
            prodDateInput.addEventListener('change', calculateExpiryForItem);
            prodDateInput.addEventListener('input', calculateExpiryForItem);
        }
        if(toggleExpiryInputAllSwitch) toggleExpiryInputAllSwitch.addEventListener('change', toggleDatesForItem);

        batchItemsDetailsContainer.appendChild(cardElement);
    }

    function renderAllDetailFormsMobile() {
        if(!batchItemsDetailsContainer || !detailsPlaceholder) return;
        batchItemsDetailsContainer.innerHTML = ''; 
        itemDetailIndexCounter = 0; 
        if (selectedProducts.size > 0) {
            detailsPlaceholder.classList.add('hidden');
            selectedProducts.forEach(product => {
                renderSingleItemDetailCardMobile(product, itemDetailIndexCounter++);
            });
            detailFormRendered = true;
        } else {
            detailsPlaceholder.classList.remove('hidden');
            detailFormRendered = false; 
        }
        updateButtonStates();
    }

    if(productSearchInput) productSearchInput.addEventListener('keypress', function(e) { if (e.key === 'Enter') { e.preventDefault(); fetchProductForSelectionMobile(this.value.trim()); }});
    if(categorySelect) categorySelect.addEventListener('change', function() { loadProductsForBrowseGridMobile(this.value, null); if(productSearchInput) productSearchInput.value = ''; if(productSearchError) productSearchError.textContent = '';});
    if(locationIdBatchSelect) locationIdBatchSelect.addEventListener('change', updateButtonStates);
    
    if(toggleExpiryInputAllSwitch) { 
        toggleExpiryInputAllSwitch.addEventListener('change', function() {
            if(batchDefaultExpiryDateRow) batchDefaultExpiryDateRow.classList.toggle('hidden', !this.checked);
            if (!this.checked && batchDefaultExpDateInput) {
                batchDefaultExpDateInput.value = ''; 
            }
            if (detailFormRendered || selectedProducts.size > 0) { 
                renderAllDetailFormsMobile(); 
            }
        });
     }
    if (applyProdDateAllBtn && batchDefaultProdDateInput && batchItemsDetailsContainer) { 
        applyProdDateAllBtn.addEventListener('click', function() {
            const defaultProdDate = batchDefaultProdDateInput.value;
            if (!defaultProdDate) { alert('กรุณาเลือกวันผลิตเริ่มต้น'); return; }
            if (!detailFormRendered && selectedProducts.size === 0) { alert('กรุณาเลือกสินค้าเข้ารายการก่อน'); return; }
            if (!detailFormRendered && selectedProducts.size > 0) { renderAllDetailFormsMobile(); } 

            batchItemsDetailsContainer.querySelectorAll('.item-detail-card-mobile').forEach(card => {
                const prodDateInput = card.querySelector('.item-production-date-mobile');
                const prodDateGroup = card.querySelector('.item-production-date-group-mobile');
                if (prodDateInput && prodDateGroup && !prodDateGroup.classList.contains('hidden')) { 
                    prodDateInput.value = defaultProdDate;
                    prodDateInput.dispatchEvent(new Event('input')); 
                }
            });
        });
    }
    if (applyExpDateAllBtn && batchDefaultExpDateInput && batchItemsDetailsContainer && toggleExpiryInputAllSwitch) { 
        applyExpDateAllBtn.addEventListener('click', function() {
            const defaultExpDate = batchDefaultExpDateInput.value;
            if (!defaultExpDate) { alert('กรุณาเลือกวันหมดอายุเริ่มต้น'); return; }
            if (!detailFormRendered && selectedProducts.size === 0) { alert('กรุณาเลือกสินค้าเข้ารายการก่อน'); return; }
            if (!detailFormRendered && selectedProducts.size > 0) { renderAllDetailFormsMobile(); } 
            if (!toggleExpiryInputAllSwitch.checked) { alert('กรุณาเปิด "กรอกวันหมดอายุตรง" ก่อนใช้ปุ่มนี้'); return;}

            batchItemsDetailsContainer.querySelectorAll('.item-detail-card-mobile').forEach(card => {
                const expDateInput = card.querySelector('.item-expiry-date-mobile');
                const expDateGroup = card.querySelector('.item-expiry-date-group-mobile');
                if (expDateInput && expDateGroup && !expDateGroup.classList.contains('hidden')) { 
                    expDateInput.value = defaultExpDate;
                }
            });
        });
     }
    
    if(batchStockInForm) batchStockInForm.addEventListener('submit', function(event) { 
        if (selectedProducts.size === 0) {
            alert('ไม่มีสินค้าในรายการ กรุณาเลือกสินค้าก่อน');
            event.preventDefault(); return;
        }
        if (locationIdBatchSelect && !locationIdBatchSelect.value) {
            alert('กรุณาเลือกสถานที่จัดเก็บสำหรับ Batch นี้');
            locationIdBatchSelect.focus();
            event.preventDefault(); return;
        }
        if (!detailFormRendered) { 
             if(selectedProducts.size > 0){ 
                renderAllDetailFormsMobile();
             } else { 
                alert('กรุณาเลือกสินค้าและกรอกรายละเอียดก่อน');
                event.preventDefault(); return;
             }
        }
        let allValid = true;
        if(batchItemsDetailsContainer) batchItemsDetailsContainer.querySelectorAll('.item-detail-card-mobile').forEach((cardElement) => {
            const qtyInput = cardElement.querySelector('.item-quantity-mobile'); 
            if (qtyInput && (!qtyInput.value || parseFloat(qtyInput.value) <= 0)) {
                allValid = false; qtyInput.classList.add('is-invalid');
            } else if(qtyInput) { qtyInput.classList.remove('is-invalid'); }

            const prodDateInput = cardElement.querySelector('.item-production-date-mobile');
            const prodDateGroup = cardElement.querySelector('.item-production-date-group-mobile');
            if (prodDateInput && prodDateGroup && !prodDateGroup.classList.contains('hidden') && prodDateInput.required && !prodDateInput.value) {
                 allValid = false; prodDateInput.classList.add('is-invalid');
            } else if (prodDateInput) { prodDateInput.classList.remove('is-invalid');}

            const expDateInput = cardElement.querySelector('.item-expiry-date-mobile');
            const expDateGroup = cardElement.querySelector('.item-expiry-date-group-mobile');
             if (expDateInput && expDateGroup && !expDateGroup.classList.contains('hidden') && expDateInput.required && !expDateInput.value) {
                 allValid = false; expDateInput.classList.add('is-invalid');
            } else if (expDateInput) { expDateInput.classList.remove('is-invalid'); }
        });
        if (!allValid) {
            alert('กรุณากรอกข้อมูลที่จำเป็น (จำนวน, วันที่) ให้ครบถ้วนและถูกต้องสำหรับสินค้าทุกรายการ');
            event.preventDefault(); return;
        }
    });
        
    updateButtonStates();
    if(categorySelect) loadProductsForBrowseGridMobile(categorySelect.value); 
    showPhase(1); 
    if(phase1Col && phase2Col) {
        window.addEventListener('resize', () => {
            let currentPhaseForMobile = 1;
            if(isMobileView() && phase2Col.style.display === 'block') {
                currentPhaseForMobile = 2;
            }
            showPhase(isMobileView() ? currentPhaseForMobile : 1); 
        });
    }

    const formDataRawScript = document.getElementById('form_data_raw_script_mobile');
    if (formDataRawScript && formDataRawScript.textContent) { 
        try {
            const rawData = JSON.parse(formDataRawScript.textContent);
            if (locationIdBatchSelect && rawData.location_id) { locationIdBatchSelect.value = rawData.location_id; }
            const batchNotesMobileEl = document.getElementById('batch_notes_mobile');
            if (batchNotesMobileEl && rawData.batch_notes) { batchNotesMobileEl.value = rawData.batch_notes; }

            if (Array.isArray(rawData.items) && rawData.items.length > 0) {
                rawData.items.forEach(item => {
                    if(item.product_id && !selectedProducts.has(parseInt(item.product_id))){ 
                         selectedProducts.set(parseInt(item.product_id), { 
                             id: parseInt(item.product_id), 
                             name: item.product_name || `Product ${item.product_id}`, 
                             sku: item.product_sku || `SKU-${item.product_id}`,
                             shelf_life_days: item.shelf_life_days !== undefined ? item.shelf_life_days : null,
                            });
                    }
                });
                
                if(selectedProductsListEl && noSelectedItemsPlaceholder){
                    selectedProductsListEl.innerHTML = ''; 
                    if (selectedProducts.size > 0) noSelectedItemsPlaceholder.classList.add('hidden');
                    else noSelectedItemsPlaceholder.classList.remove('hidden');

                    selectedProducts.forEach(p => {
                        const listItem = document.createElement('li');
                        listItem.className = 'list-group-item d-flex justify-content-between align-items-center';
                        listItem.dataset.productId = p.id;
                        listItem.innerHTML = `<span class="product-info">${p.name} (SKU: ${p.sku})</span>
                                              <button type="button" class="btn btn-danger btn-sm remove-item-btn"><i class="bi bi-x-lg"></i></button>`;
                        listItem.querySelector('.remove-item-btn').onclick = function() { /* ... (remove logic from previous version) ... */ };
                        selectedProductsListEl.appendChild(listItem);
                    });
                }
                
                if (productBrowseGrid) { // Check if grid exists
                    const updateGridSelection = () => {
                        productBrowseGrid.querySelectorAll('.product-card-mobile').forEach(card => {
                            const cardProductId = parseInt(card.dataset.productId);
                            if (selectedProducts.has(cardProductId)) card.classList.add('selected');
                            else card.classList.remove('selected');
                        });
                    };

                    if (productBrowseGrid.childElementCount > 0 && !productBrowseGrid.querySelector('.spinner-border')) {
                        updateGridSelection();
                    } else if (categorySelect) { 
                         loadProductsForBrowseGridMobile(categorySelect.value, null).then(updateGridSelection);
                    }
                }

                updateButtonStates(); 

                if (selectedProducts.size > 0) {
                    renderAllDetailFormsMobile(); 
                    
                    let currentItemIndex = 0; 
                    selectedProducts.forEach(productFromMap => {
                         const itemFromRawData = rawData.items.find(itRaw => parseInt(itRaw.product_id) === productFromMap.id);
                         if (itemFromRawData && batchItemsDetailsContainer) {
                            const card = batchItemsDetailsContainer.querySelector(`.item-detail-card-mobile[data-product-id-mobile="${productFromMap.id}"]`);
                            if (card) {
                                const qtyInput = card.querySelector(`input[name="items[${currentItemIndex}][quantity]"]`);
                                if (qtyInput && itemFromRawData.quantity) qtyInput.value = itemFromRawData.quantity;
                                
                                const prodDateInput = card.querySelector(`input[name="items[${currentItemIndex}][production_date]"]`);
                                const expDateInput = card.querySelector(`input[name="items[${currentItemIndex}][expiry_date]"]`);
                                const prodDateGroup = card.querySelector('.item-production-date-group-mobile');
                                
                                if (prodDateInput && prodDateGroup && itemFromRawData.production_date && !prodDateGroup.classList.contains('hidden')) {
                                    prodDateInput.value = itemFromRawData.production_date;
                                    prodDateInput.dispatchEvent(new Event('input')); 
                                }
                                if (expDateInput && itemFromRawData.expiry_date ) {
                                     const shelfLifeVal = card.querySelector('.item-shelf-life-mobile') ? card.querySelector('.item-shelf-life-mobile').value : '';
                                     const isDirectExpiryMode = toggleExpiryInputAllSwitch ? toggleExpiryInputAllSwitch.checked : false;
                                     const hasShelfLife = shelfLifeVal !== '' && !isNaN(parseInt(shelfLifeVal, 10)) && parseInt(shelfLifeVal, 10) >=0;
                                     const expDateGroup = card.querySelector('.item-expiry-date-group-mobile');

                                     if(expDateGroup && (isDirectExpiryMode || !hasShelfLife)){ 
                                        if(!expDateGroup.classList.contains('hidden')){
                                            expDateInput.value = itemFromRawData.expiry_date;
                                        }
                                     }
                                }
                            }
                         }
                         currentItemIndex++;
                    });
                    
                    detailFormRendered = true; 
                     if(isMobileView()){ 
                         showPhase(2); 
                     } else {
                         showPhase(1); 
                     }
                } else { 
                     showPhase(1);
                }
            } else { 
                 showPhase(1);
            }
            updateButtonStates(); 

        } catch(e) { 
            console.error("Error repopulating form from session data:", e);
            showPhase(1); 
        }
    } else {
        showPhase(1); 
    }
});
</script>
{% endblock %}