{% extends "base.html" %}

{% block title %}รับสินค้าเข้า - GoFresh StockPro{% endblock %}

{% block head_extra %}
{# Add any specific styles if needed #}
<style>
    .form-label { margin-bottom: 0.25rem; }
    .form-select-sm, .form-control-sm { font-size: 0.875rem; }
</style>
{% endblock %}

{% block content %}
<h1><i class="bi bi-box-arrow-in-down me-2"></i>บันทึกการรับสินค้าเข้า</h1>
<hr>

{% if error %}
    <div class="alert alert-danger alert-dismissible fade show" role="alert">
        <strong><i class="bi bi-exclamation-triangle-fill me-2"></i>ข้อผิดพลาด:</strong> {{ error }}
        <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
    </div>
{% endif %}
{% if message %} {# Assuming success message might be passed via query params #}
     <div class="alert alert-success alert-dismissible fade show" role="alert">
        <strong><i class="bi bi-check-circle-fill me-2"></i>สำเร็จ:</strong> {{ message }}
        <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
    </div>
{% endif %}

{# Use url_for to generate the form action URL, ensure the route name is correct #}
<form method="post" action="{{ request.app.url_path_for('ui_handle_stock_in_form') }}">
    <div class="row g-3 p-3 border rounded bg-light">
         {# --- Cascading Dropdown for Product Selection --- #}
         <div class="col-md-6 mb-3">
            <label for="category_select" class="form-label">หมวดหมู่สินค้า <span class="text-danger">*</span></label>
            {# Use a different name for the display select to avoid confusion with hidden category_id if needed #}
            <select class="form-select form-select-sm" id="category_select" name="category_select_display" required>
                <option value="">-- เลือกหมวดหมู่ก่อน --</option>
                {% for category in categories %}
                    {# Pre-select category if coming back from an error and form_data contains category_id #}
                    {# Note: We need category_id in form_data for this to work reliably after error #}
                    <option value="{{ category.id }}"
                            {% if form_data and form_data.get('category_id')|string == category.id|string %}selected{% endif %}>
                            {# Example: form_data might need category_id if product_id is known #}
                        {{ category.name }}
                    </option>
                {% endfor %}
            </select>
        </div>
        <div class="col-md-6 mb-3">
            <label for="product_select" class="form-label">สินค้า <span class="text-danger">*</span></label>
            {# This select is populated by JS. The actual product_id is submitted via the hidden input. #}
            <select class="form-select form-select-sm" id="product_select" name="product_select_display_only" required disabled>
                <option value="">-- กรุณาเลือกหมวดหมู่ก่อน --</option>
            </select>
            {# Hidden input that will hold the actual product_id for submission #}
            <input type="hidden" id="product_id" name="product_id" value="{{ form_data.product_id if form_data else '' }}">
        </div>
        {# ------------------------------------------------- #}

        <div class="col-md-6 mb-3">
            <label for="location_id" class="form-label">สถานที่จัดเก็บ <span class="text-danger">*</span></label>
            <select class="form-select form-select-sm" id="location_id" name="location_id" required>
                <option value="">-- เลือกสถานที่ --</option>
                {% for location in locations %}
                    <option value="{{ location.id }}"
                            {% if form_data and form_data.location_id|string == location.id|string %}selected{% endif %}>
                        {{ location.name }}
                    </option>
                {% endfor %}
            </select>
        </div>
        <div class="col-md-6 mb-3">
            <label for="quantity" class="form-label">จำนวน <span class="text-danger">*</span></label>
            <input type="number" min="1" step="1" class="form-control form-control-sm" id="quantity" name="quantity" required
                   value="{{ form_data.quantity if form_data else '' }}">
        </div>
        <div class="col-md-6 mb-3">
            <label for="cost_per_unit" class="form-label">ต้นทุนต่อหน่วย (บาท)</label>
            <input type="number" step="0.01" min="0" class="form-control form-control-sm" id="cost_per_unit" name="cost_per_unit"
                   placeholder="เช่น 150.75"
                   value="{{ form_data.cost_per_unit if form_data and form_data.cost_per_unit is not none else '' }}">
                   {# Display empty string if value is None or not present #}
        </div>
        <div class="col-md-6 mb-3">
            <label for="expiry_date" class="form-label">วันหมดอายุ (ถ้ามี)</label>
            <input type="date" class="form-control form-control-sm" id="expiry_date" name="expiry_date"
                   value="{{ form_data.expiry_date if form_data else '' }}">
        </div>
         <div class="col-12 mb-3">
            <label for="notes" class="form-label">หมายเหตุ</label>
            <textarea class="form-control form-control-sm" id="notes" name="notes" rows="3">{{ form_data.notes if form_data else '' }}</textarea>
        </div>
    </div>

    <div class="mt-4">
        <button type="submit" class="btn btn-primary"><i class="bi bi-save me-2"></i>บันทึกรับเข้า</button>
        <a href="{{ request.app.url_path_for('ui_view_inventory_summary') }}" class="btn btn-secondary"><i class="bi bi-x-lg me-2"></i>ยกเลิก</a>
    </div>
</form>
{% endblock %}

{# --- JavaScript Block for Cascading Dropdown and Cost Pre-fill --- #}
{% block scripts_extra %}
<script>
    const categorySelect = document.getElementById('category_select');
    const productSelect = document.getElementById('product_select');
    const productIdInput = document.getElementById('product_id'); // Hidden input
    const costInput = document.getElementById('cost_per_unit');

    async function fetchAndPopulateProducts(categoryId, selectedProductId = null) {
        // Clear and disable product select
        productSelect.innerHTML = '<option value="">กำลังโหลด...</option>';
        productSelect.disabled = true;
        productIdInput.value = selectedProductId || ''; // Update hidden input

        if (!categoryId) {
            productSelect.innerHTML = '<option value="">-- เลือกหมวดหมู่ก่อน --</option>';
            if (!costInput.value && document.activeElement !== costInput) { // Avoid clearing if user is typing
                costInput.value = '';
            }
            return;
        }

        try {
            const response = await fetch(`/api/products/by-category/${categoryId}/basic`);

            if (!response.ok) {
                // Handle non-OK responses (like 404 Not Found) gracefully
                if (response.status === 404) {
                    productSelect.innerHTML = '<option value="">-- ไม่มีสินค้าในหมวดนี้ --</option>';
                    console.warn(`No products found for category ID ${categoryId}`);
                } else {
                    // For other errors, show a generic error message
                    productSelect.innerHTML = `<option value="">-- ข้อผิดพลาด ${response.status} --</option>`;
                    console.error(`HTTP error! status: ${response.status}`);
                }
                if (!costInput.value && document.activeElement !== costInput) { costInput.value = ''; }
                return; // Exit the function after handling error/no data
            }

            const products = await response.json();
            productSelect.innerHTML = '<option value="">-- เลือกสินค้า --</option>'; // Reset placeholder

            if (products && products.length > 0) {
                products.forEach(product => {
                    const option = document.createElement('option');
                    option.value = product.id;
                    option.textContent = `${product.name} (SKU: ${product.sku})`;
                    // Store standard_cost in dataset (ensure it's included in ProductBasic schema)
                    option.dataset.cost = product.standard_cost !== null && product.standard_cost !== undefined
                                          ? parseFloat(product.standard_cost).toFixed(2)
                                          : '';
                    if (selectedProductId && parseInt(product.id) === parseInt(selectedProductId)) {
                        option.selected = true;
                    }
                    productSelect.appendChild(option);
                });
                productSelect.disabled = false; // Enable product select

                // Trigger change if pre-selected to fill cost
                if (selectedProductId) {
                    productSelect.dispatchEvent(new Event('change'));
                } else if (!costInput.value && document.activeElement !== costInput) {
                    costInput.value = ''; // Clear cost only if not pre-filled and not being typed in
                }

            } else {
                // API returned 200 OK but products array is empty
                productSelect.innerHTML = '<option value="">-- ไม่มีสินค้าในหมวดนี้ --</option>';
                if (!costInput.value && document.activeElement !== costInput) { costInput.value = ''; }
            }
        } catch (error) {
            console.error('Error fetching or processing products:', error);
            productSelect.innerHTML = '<option value="">-- เกิดข้อผิดพลาดในการโหลด --</option>';
            if (!costInput.value && document.activeElement !== costInput) { costInput.value = ''; }
        }
    }

    // Event listener for category dropdown
    categorySelect.addEventListener('change', function() {
        fetchAndPopulateProducts(this.value);
    });

    // Event listener for product dropdown
    productSelect.addEventListener('change', function() {
         productIdInput.value = this.value; // Update hidden input
         const selectedOption = this.options[this.selectedIndex];

         // Pre-fill cost only if cost field is currently empty
         if (selectedOption && selectedOption.value && selectedOption.dataset.cost !== undefined) {
             if (!costInput.value) { // Check if cost input is empty before pre-filling
                 costInput.value = selectedOption.dataset.cost;
             }
         } else {
             // Clear cost only if '-- เลือกสินค้า --' is selected AND cost field is empty
             if (!this.value && !costInput.value) {
                 costInput.value = '';
             }
         }
    });

    // Initial load logic (e.g., when returning from form error)
    document.addEventListener('DOMContentLoaded', (event) => {
        const initialProductId = productIdInput.value; // From hidden input value set by Jinja
        const initialCategoryId = categorySelect.value; // From selected option set by Jinja

        // If a category is selected on load, trigger product fetch
        if (initialCategoryId) {
            console.log(`Initial load - Category ID: ${initialCategoryId}, Product ID: ${initialProductId || 'None'}`);
            fetchAndPopulateProducts(initialCategoryId, initialProductId);
        }
    });

</script>
{% endblock %}