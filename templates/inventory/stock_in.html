{% extends "base.html" %}

{% block title %}รับสินค้าเข้า - GoFresh StockPro{% endblock %}

{% block content %}
<h1>บันทึกการรับสินค้าเข้า</h1>
<hr>

{% if error %}
    <div class="alert alert-danger" role="alert">
        ข้อผิดพลาด: {{ error }}
    </div>
{% endif %}

{# ใช้ url_for ถ้า router ถูกตั้งชื่อไว้ หรือใช้ path ตรงๆ #}
<form method="post" action="{{ url_for('ui_handle_stock_in_form') if request.url_for else '/ui/inventory/stock-in/' }}">
    <div class="row g-3">
         {# --- Cascading Dropdown --- #}
         <div class="col-md-6 mb-3">
            <label for="category_select" class="form-label">หมวดหมู่ <span class="text-danger">*</span></label>
            <select class="form-select" id="category_select" name="category_select" required>
                <option value="">-- เลือกหมวดหมู่ก่อน --</option>
                {% for category in categories %}
                    {# หากกลับมาจาก error และมี category_id ค้างอยู่ ให้เลือก category นั้นไว้ #}
                    <option value="{{ category.id }}" {% if form_data and form_data.get('category_id')|int == category.id %}selected{% endif %}>
                        {{ category.name }}
                    </option>
                {% endfor %}
            </select>
        </div>
        <div class="col-md-6 mb-3">
            <label for="product_select" class="form-label">สินค้า <span class="text-danger">*</span></label>
            <select class="form-select" id="product_select" name="product_select_display" required disabled>
                 {# Option เริ่มต้นจะถูกสร้างโดย JS #}
                 {# ถ้ามี form_data (กลับมาจาก error) อาจจะต้องให้ JS โหลด product ของ category ที่เลือกไว้เลย #}
                <option value="">-- เลือกหมวดหมู่ก่อน --</option>
            </select>
            {# Input ที่ซ่อนไว้สำหรับส่ง product_id จริงๆ #}
            <input type="hidden" id="product_id" name="product_id" value="{{ form_data.product_id if form_data else '' }}">
        </div>
        {# --------------------------- #}

        <div class="col-md-6 mb-3">
            <label for="location_id" class="form-label">สถานที่จัดเก็บ <span class="text-danger">*</span></label>
            <select class="form-select" id="location_id" name="location_id" required>
                <option value="">-- เลือกสถานที่ --</option>
                {% for location in locations %}
                    <option value="{{ location.id }}"
                            {% if form_data and form_data.location_id|int == location.id %}selected{% endif %}>
                        {{ location.name }}
                    </option>
                {% endfor %}
            </select>
        </div>
        <div class="col-md-6 mb-3">
            <label for="quantity" class="form-label">จำนวน <span class="text-danger">*</span></label>
            <input type="number" min="1" step="1" class="form-control" id="quantity" name="quantity" required
                   value="{{ form_data.quantity if form_data else '' }}">
        </div>
        <div class="col-md-6 mb-3">
            <label for="cost_per_unit" class="form-label">ต้นทุนต่อหน่วย</label>
            {# ตรวจสอบให้แน่ใจว่ามี id="cost_per_unit" #}
            <input type="number" step="0.01" min="0" class="form-control" id="cost_per_unit" name="cost_per_unit"
                   value="{{ form_data.cost_per_unit if form_data else '' }}">
        </div>
        <div class="col-md-6 mb-3">
            <label for="expiry_date" class="form-label">วันหมดอายุ</label>
            <input type="date" class="form-control" id="expiry_date" name="expiry_date"
                   value="{{ form_data.expiry_date if form_data else '' }}">
        </div>
         <div class="col-12 mb-3">
            <label for="notes" class="form-label">หมายเหตุ</label>
            <textarea class="form-control" id="notes" name="notes" rows="3">{{ form_data.notes if form_data else '' }}</textarea>
        </div>
    </div>

    <button type="submit" class="btn btn-primary">บันทึกรับเข้า</button>
    {# ใช้ url_for ถ้า router ถูกตั้งชื่อไว้ หรือใช้ path ตรงๆ #}
    <a href="{{ url_for('ui_view_inventory_summary') if request.url_for else '/ui/inventory/summary/' }}" class="btn btn-secondary">ยกเลิก</a>
</form>
{% endblock %}

{# --- JavaScript Block --- #}
{% block scripts_extra %}
<script>
    const categorySelect = document.getElementById('category_select');
    const productSelect = document.getElementById('product_select');
    const productIdInput = document.getElementById('product_id');
    const costInput = document.getElementById('cost_per_unit');

    // Function to fetch products for a given category and populate dropdown
    async function fetchAndPopulateProducts(categoryId, selectedProductId = null) {
        productSelect.innerHTML = '<option value="">กำลังโหลด...</option>';
        productSelect.disabled = true;
        productIdInput.value = selectedProductId || ''; // Set hidden input based on selection
        // costInput.value = ''; // Don't clear cost here yet

        if (categoryId) {
            try {
                const response = await fetch(`/api/products/by-category/${categoryId}/basic`);
                if (!response.ok) { throw new Error(`HTTP error! status: ${response.status}`); }
                const products = await response.json();

                productSelect.innerHTML = '<option value="">-- เลือกสินค้า --</option>'; // Reset options
                if (products.length > 0) {
                    products.forEach(product => {
                        const option = document.createElement('option');
                        option.value = product.id;
                        option.textContent = `${product.name} (SKU: ${product.sku})`;
                        // Store standard_cost in dataset
                        option.dataset.cost = product.standard_cost !== null && product.standard_cost !== undefined
                                              ? parseFloat(product.standard_cost).toFixed(2)
                                              : '';
                        // If this product ID matches the one we want to pre-select, mark it
                        if (selectedProductId && parseInt(product.id) === parseInt(selectedProductId)) {
                            option.selected = true;
                        }
                        productSelect.appendChild(option);
                    });
                     productSelect.disabled = false;
                     // Trigger change event manually if a product was pre-selected
                     // This ensures the cost field is pre-filled on page load after error
                     if (selectedProductId) {
                         productSelect.dispatchEvent(new Event('change'));
                     } else {
                         costInput.value = ''; // Clear cost if no product is pre-selected
                     }

                } else {
                     productSelect.innerHTML = '<option value="">-- ไม่มีสินค้าในหมวดนี้ --</option>';
                     costInput.value = ''; // Clear cost if no products
                }
            } catch (error) {
                console.error('Error fetching products:', error);
                productSelect.innerHTML = '<option value="">-- เกิดข้อผิดพลาด --</option>';
                costInput.value = ''; // Clear cost on error
            }
        } else {
             productSelect.innerHTML = '<option value="">-- เลือกหมวดหมู่ก่อน --</option>';
             costInput.value = ''; // Clear cost if no category
        }
    }

    // Event listener for category dropdown
    categorySelect.addEventListener('change', function() {
        fetchAndPopulateProducts(this.value); // Fetch products for the newly selected category
    });

    // Event listener for product dropdown
    productSelect.addEventListener('change', function() {
         productIdInput.value = this.value; // Update hidden product ID input
         const selectedOption = this.options[this.selectedIndex];

         if (selectedOption && selectedOption.value) {
             const standardCost = selectedOption.dataset.cost;
             costInput.value = standardCost || ''; // Set cost input value (or empty if no cost)
         } else {
             costInput.value = ''; // Clear cost if '-- เลือกสินค้า --' is selected
         }
    });

    // --- Logic to handle page load, especially after form error ---
    document.addEventListener('DOMContentLoaded', (event) => {
        const initialProductId = productIdInput.value;
        const initialCategoryId = categorySelect.value;

        // If a category is already selected on load (likely due to form_data)
        // fetch the products for that category and try to select the initial product
        if (initialCategoryId) {
            // Check if the product dropdown is empty or just has the placeholder
             const productOptionsPopulated = productSelect.options.length > 1 && productSelect.options[1].value !== '';
             if (!productOptionsPopulated || (initialProductId && productSelect.value !== initialProductId)) {
                  fetchAndPopulateProducts(initialCategoryId, initialProductId);
             } else if (initialProductId && productSelect.value === initialProductId) {
                 // If correct product is already selected, ensure cost is prefilled
                  const selectedOption = productSelect.options[productSelect.selectedIndex];
                   if (selectedOption && selectedOption.dataset.cost !== undefined) {
                       // Only set cost if the input doesn't already have a value (from form_data)
                       if (!costInput.value && selectedOption.dataset.cost) {
                            costInput.value = selectedOption.dataset.cost;
                       }
                   }
             }
        }
    });

</script>
{% endblock %}