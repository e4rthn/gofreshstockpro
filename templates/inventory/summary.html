{% extends "base.html" %}

{% block title %}สรุปสต็อกคงคลัง - GoFresh StockPro{% endblock %}

{% block head_extra %}
<link rel="stylesheet" type="text/css" href="https://cdn.datatables.net/1.13.6/css/dataTables.bootstrap5.min.css">
<style>
    .stock-low { color: orange; font-weight: bold; }
    .stock-negative { color: red; font-weight: bold; }
    div.dataTables_wrapper div.dataTables_length select,
    div.dataTables_wrapper div.dataTables_filter input {
        width: auto; display: inline-block; margin-left: 0.5em;
    }
    .filter-form-section { margin-bottom: 0.5rem; } /* Reduced bottom margin */
    .nav-pills .nav-link {
        padding: 0.35rem 0.7rem; /* Smaller padding for pills */
        font-size: 0.875rem; /* Smaller font size */
    }
    .form-select-sm { font-size: 0.875rem; padding-top: 0.25rem; padding-bottom: 0.25rem;} /* Adjust select size */
    .btn-sm { font-size: 0.875rem; padding: 0.25rem 0.5rem; }
</style>
{% endblock %}

{% block content %}
<div class="d-flex justify-content-between align-items-center mb-3">
    <h1>สรุปสต็อกคงคลัง {% if selected_location_id %}- {% for loc in all_locations %}{% if loc.id == selected_location_id %}{{ loc.name }}{% endif %}{% endfor %}{% elif not selected_location_id and all_locations|length > 1 %} (ทุกสถานที่){% endif %}</h1>
    <div>
        <a href="{{ request.app.url_path_for('ui_show_adjustment_form') }}" class="btn btn-warning btn-sm"><i class="bi bi-pencil-square me-1"></i>ปรับปรุงสต็อก</a>
        <a href="{{ request.app.url_path_for('ui_show_stock_in_form') }}" class="btn btn-success btn-sm"><i class="bi bi-plus-circle-fill me-1"></i>รับสินค้าเข้า</a>
    </div>
</div>

{% if message %}
    <div class="alert alert-success alert-dismissible fade show" role="alert"> {{ message }} <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button> </div>
{% endif %}
{% if error %}
    <div class="alert alert-danger alert-dismissible fade show" role="alert"> ข้อผิดพลาด: {{ error }} <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button> </div>
{% endif %}

{# --- ฟอร์มกรอง --- #}
<div class="mb-4 p-3 border rounded bg-light">
    <div class="row g-2 align-items-end"> {# g-2 for smaller gutters #}
        {% if all_locations|length > 1 %}
        <div class="col-md-auto filter-form-section"> {# col-md-auto to fit content #}
            <label class="form-label d-block mb-1">เลือกสถานที่:</label>
            <ul class="nav nav-pills nav-pills-secondary flex-wrap">
                <li class="nav-item me-1 mb-1">
                    <a class="nav-link {% if not selected_location_id %}active{% endif %}"
                       href="{{ create_filter_link(location=None, category=selected_category_id, limit=limit) }}">
                        ทุกสถานที่
                    </a>
                </li>
                {% for loc in all_locations %}
                <li class="nav-item me-1 mb-1">
                    <a class="nav-link {% if selected_location_id and selected_location_id|string == loc.id|string %}active{% endif %}"
                       href="{{ create_filter_link(location=loc.id, category=selected_category_id, limit=limit) }}">
                        {{ loc.name }}
                    </a>
                </li>
                {% endfor %}
            </ul>
        </div>
        {% elif all_locations|length == 1 and not selected_location_id %}
             {# If only one location, it's implicitly selected if no filter is active.
                The backend will handle location_id=None as 'all' or the single one if logic implies.
                Or, to always filter by the single one:
                <input type="hidden" name="location" value="{{ all_locations[0].id }}">
             #}
        {% endif %}

        <div class="col-md-3 filter-form-section"> {# Adjust width as needed #}
            <label for="category_filter" class="form-label mb-1">หมวดหมู่:</label>
            <form id="categoryFilterForm" method="get" action="{{ request.app.url_path_for('ui_view_inventory_summary') }}" class="d-flex">
                <input type="hidden" name="location" value="{{ selected_location_id if selected_location_id else '' }}">
                <input type="hidden" name="limit" value="{{ limit }}">
                <input type="hidden" name="page" value="1"> {# Always reset to page 1 on category change #}
                <select class="form-select form-select-sm" id="category_filter" name="category" onchange="this.form.submit()">
                    <option value="">-- ทุกหมวดหมู่ --</option>
                    {% for cat in all_categories %}
                        <option value="{{ cat.id }}" {% if selected_category_id and selected_category_id|string == cat.id|string %}selected{% endif %}>
                            {{ cat.name }}
                        </option>
                    {% endfor %}
                </select>
            </form>
        </div>
        <div class="col-md-auto filter-form-section d-flex align-items-end">
            <a href="{{ request.app.url_path_for('ui_view_inventory_summary') }}?limit={{limit}}" class="btn btn-outline-secondary btn-sm">ล้างค่ากรอง</a>
        </div>
    </div>
</div>
{# --------------------------------- #}

{% if total_count > 0 %}
<p>
    พบข้อมูลทั้งหมด {{ total_count }} รายการ
    {% if selected_location_id %}{% for loc in all_locations %}{% if loc.id|string == selected_location_id|string %} ใน <strong>{{ loc.name }}</strong>{% endif %}{% endfor %}{% endif %}
    {% if selected_category_id %}{% for cat in all_categories %}{% if cat.id|string == selected_category_id|string %} ประเภท <strong>{{ cat.name }}</strong>{% endif %}{% endfor %}{% endif %}
    (หน้าที่ {{ page }} / {{ total_pages }})
</p>
{% elif selected_location_id or selected_category_id %}
<p class="text-muted mt-3">ไม่พบข้อมูลสต็อกตามเงื่อนไขที่เลือก</p>
{% else %}
{% endif %}

{% if stock_summary %}
<div class="table-responsive">
    <table class="table table-striped table-hover table-sm" id="stockSummaryTable" data-page-length="{{ limit | default(15) }}">
        <thead class="table-light">
            <tr>
                {% if not selected_location_id and all_locations|length > 1 %}
                <th>สถานที่จัดเก็บ</th>
                {% endif %}
                <th>ชื่อสินค้า</th>
                <th>SKU</th>
                <th>หมวดหมู่</th>
                <th class="text-end">จำนวนคงเหลือ</th>
                <th>อัปเดตล่าสุด</th>
            </tr>
        </thead>
        <tbody>
            {% for item in stock_summary %}
            <tr>
                {% if not selected_location_id and all_locations|length > 1 %}
                <td>{{ item.location.name if item.location else 'N/A' }}</td>
                {% endif %}
                <td>
                    <a href="{{ request.app.url_path_for('ui_show_edit_product_form', product_id=item.product.id) if item.product else '#' }}" title="แก้ไขรายละเอียดสินค้า {{ item.product.name if item.product }}">
                        {{ item.product.name if item.product else 'N/A' }}
                    </a>
                </td>
                <td>{{ item.product.sku if item.product else 'N/A' }}</td>
                <td>{{ item.product.category.name if item.product and item.product.category else 'N/A' }}</td>
                <td class="text-end
                    {% if item.quantity < 0 %}stock-negative{% elif item.quantity >= 0 and item.quantity <= 5 %}stock-low{% endif %}">
                    {{ item.quantity }}
                </td>
                <td>{{ item.last_updated.strftime('%Y-%m-%d %H:%M') if item.last_updated else '-'}}</td>
            </tr>
            {% endfor %}
        </tbody>
    </table>
</div>
{% elif not selected_category_id and not selected_location_id and total_count == 0 %}
<p class="text-muted mt-3">ไม่พบข้อมูลสต็อกปัจจุบันในระบบ</p>
<p>ลอง <a href="{{ request.app.url_path_for('ui_show_stock_in_form') }}">รับสินค้าเข้า</a> หรือ <a href="{{ request.app.url_path_for('ui_list_stock_count_sessions') }}">ตรวจนับสต็อก</a> เพื่อเริ่มต้น</p>
{% endif %}

{% if total_pages > 1 %}
<div class="mt-4 d-flex justify-content-center">
    {% include '_pagination.html' %}
</div>
{% endif %}
{% endblock %}

{% block scripts_extra %}
<script src="https://code.jquery.com/jquery-3.7.0.js"></script>
<script src="https://cdn.datatables.net/1.13.6/js/jquery.dataTables.min.js"></script>
<script src="https://cdn.datatables.net/1.13.6/js/dataTables.bootstrap5.min.js"></script>
<script>
$(document).ready(function() {
    var $stockTable = $('#stockSummaryTable');
    if ($stockTable.length && $stockTable.find('tbody tr').filter(function() { return $(this).find('td').length > 0; }).length > 0) {
        var pageLengthAttr = $stockTable.data('page-length');
        var pageLength = 15;
        if (pageLengthAttr && !isNaN(parseInt(pageLengthAttr)) && parseInt(pageLengthAttr) > 0) {
            pageLength = parseInt(pageLengthAttr);
        }
        var columnsInHeader = $stockTable.find('thead th').length;
        var orderingEnabled = columnsInHeader > 1;

        $stockTable.DataTable({
            "pageLength": pageLength,
            "searching": true,
            "ordering": orderingEnabled,
            "order": [],
            "language": { /* ... (ภาษาไทยเหมือนเดิม) ... */
                "decimal":        "", "emptyTable":     "ไม่มีข้อมูลในตาราง", "info":           "แสดง _START_ ถึง _END_ จาก _TOTAL_ รายการ", "infoEmpty":      "แสดง 0 ถึง 0 จาก 0 รายการ", "infoFiltered":   "(กรองจากทั้งหมด _MAX_ รายการ)", "infoPostFix":    "", "thousands":      ",", "lengthMenu":     "แสดง _MENU_ รายการต่อหน้า", "loadingRecords": "กำลังโหลด...", "processing":     "กำลังประมวลผล...", "search":         "ค้นหาในตาราง:", "zeroRecords":    "ไม่พบรายการที่ค้นหา",
                "paginate": { "first": "หน้าแรก", "last": "หน้าสุดท้าย", "next": "ถัดไป", "previous": "ก่อนหน้า" },
                "aria": { "sortAscending":  ": เรียงจากน้อยไปมาก", "sortDescending": ": เรียงจากมากไปน้อย" }
            }
        });
    }
});
</script>
{% endblock %}