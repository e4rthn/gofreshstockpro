{% extends "base.html" %}
{% block title %}บันทึกการขาย (POS) - GoFresh StockPro{% endblock %}

{% block head_extra %}
<style>
    #sale-items-table tbody tr td { vertical-align: middle; }
    .remove-item-btn { padding: 0.1rem 0.4rem; font-size: 0.8rem; }
    .category-tabs .nav-link { cursor: pointer; }
    #product-grid { max-height: 400px; overflow-y: auto; }
    .product-card {
        border: 1px solid #ddd; padding: 0.5rem; margin: 0.25rem; cursor: pointer;
        text-align: center; min-height: 100px; display: flex; flex-direction: column;
        justify-content: space-between;
    }
    .product-card:hover { background-color: #f0f0f0; }
    .product-name { font-size: 0.9rem; font-weight: bold; }
    .product-price { font-size: 0.85rem; color: #007bff; }
    .product-sku { font-size: 0.75rem; color: #6c757d; }
    .location-btn-group .btn { border-radius: .25rem !important; margin-right: 5px; }
    #scan-input-container { margin-bottom: 1rem; }
    #scan-error { min-height: 1.2em; } /* Reserve space for error message */
</style>
{% endblock %}

{% block content %}
<h1>บันทึกการขาย (POS)</h1>
<hr>

{% if message %}
    <div class="alert alert-success alert-dismissible fade show" role="alert">
        {{ message }}
        <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
    </div>
{% endif %}
{% if error %}
    <div class="alert alert-danger alert-dismissible fade show" role="alert">
       ข้อผิดพลาด: {{ error }}
       <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
    </div>
    {% if ask_override and "สต็อกในระบบไม่เพียงพอ" in error %}
    <div class="alert alert-warning mt-2" role="alert">
        <strong>สต็อกในระบบไม่เพียงพอ!</strong> หากคุณยืนยันว่ามีสินค้าจริงหน้าร้าน และต้องการขายต่อ,
        กรุณาทำเครื่องหมายที่ช่อง "ยืนยันการขายแม้สต็อกในระบบไม่พอ" ด้านล่าง แล้วลองบันทึกอีกครั้ง
    </div>
    {% endif %}
{% endif %}

<form id="pos-form" method="post" action="{{ url_for('ui_handle_pos_form') }}">
    <div class="row">
        <div class="col-lg-7 col-md-6 mb-3">
            <h5>เลือกสินค้า</h5>
            <div class="mb-3">
                <label class="form-label d-block">สถานที่ขาย <span class="text-danger">*</span></label>
                <div class="btn-group location-btn-group" role="group" aria-label="สถานที่ขาย">
                    {% for location in locations %}
                        <input type="radio" class="btn-check" name="location_id" id="location_{{ location.id }}" value="{{ location.id }}" autocomplete="off" {% if loop.first %}required{% endif %}>
                        <label class="btn btn-outline-primary" for="location_{{ location.id }}">{{ location.name }}</label>
                    {% endfor %}
                </div>
            </div>
            <hr>

            <div id="scan-input-container">
                <label for="scan-input" class="form-label">สแกน/กรอกรหัส (SKU/Barcode) แล้ว Enter:</label>
                <input type="text" class="form-control form-control-lg" id="scan-input" placeholder="รอรับการสแกน...">
                <div id="scan-error" class="text-danger small mt-1"></div>
            </div>
            <hr>

            <ul class="nav nav-tabs category-tabs mb-2">
                {% for category in categories %}
                <li class="nav-item">
                    <a class="nav-link {% if loop.first %}active{% endif %}"
                       data-bs-toggle="tab" href="#category-pane-{{ category.id }}"
                       role="tab" data-category-id="{{ category.id }}">
                       {{ category.name }}
                    </a>
                </li>
                {% endfor %}
            </ul>
            <div class="border p-2 bg-light" style="min-height: 250px;">
                <div id="product-grid" class="row row-cols-2 row-cols-sm-3 row-cols-md-3 row-cols-lg-4 g-2">
                    <p id="product-grid-placeholder" class="text-muted p-3">กรุณาเลือกหมวดหมู่เพื่อแสดงสินค้า...</p>
                </div>
            </div>
        </div>

        <div class="col-lg-5 col-md-6 mb-3">
            <h5>รายการขายปัจจุบัน</h5>
            <div class="table-responsive mb-3" style="max-height: 350px; overflow-y: auto;">
                <table id="sale-items-table" class="table table-sm table-bordered">
                    <thead class="table-dark sticky-top">
                        <tr>
                            <th>สินค้า (SKU)</th>
                            <th class="text-end" style="width: 80px;">จำนวน</th>
                            <th class="text-end">ราคา/หน่วย</th>
                            <th class="text-end">รวม</th>
                            <th class="text-center">ลบ</th>
                        </tr>
                    </thead>
                    <tbody>
                        <tr id="no-items-row"><td colspan="5" class="text-center text-muted">ยังไม่มีรายการสินค้า</td></tr>
                    </tbody>
                </table>
            </div>
            <div class="d-flex justify-content-end align-items-center mb-2">
                <h4 class="me-3">ยอดรวมสุทธิ:</h4>
                <h4 id="sale-total" class="text-primary">0.00</h4>
            </div>
             <div class="mb-3">
                <label for="notes" class="form-label">หมายเหตุการขาย</label>
                <textarea class="form-control form-control-sm" id="notes" name="notes" rows="2"></textarea>
            </div>
            <div id="sale-items-data"></div>

            <div class="mb-3 form-check">
                <input type="checkbox" class="form-check-input" id="override_stock_check" name="override_stock_check" value="True" {% if ask_override %}checked{% endif %}>
                <label class="form-check-label" for="override_stock_check">ยืนยันการขายแม้สต็อกในระบบไม่พอ</label>
            </div>

            <div class="d-grid gap-2">
                <button type="submit" class="btn btn-primary btn-lg">บันทึกการขาย</button>
                <a href="{{ url_for('ui_root_redirect') }}" class="btn btn-secondary">ยกเลิก</a>
            </div>
        </div>
    </div>
</form>
{% endblock %}

{% block scripts_extra %}
<script>
    // DOM Elements
    const categoryTabs = document.querySelectorAll('.category-tabs .nav-link');
    const productGrid = document.getElementById('product-grid');
    const productGridPlaceholder = document.getElementById('product-grid-placeholder');
    const saleItemsTableBody = document.querySelector('#sale-items-table tbody');
    const noItemsRow = document.getElementById('no-items-row');
    const saleTotalElement = document.getElementById('sale-total');
    const saleItemsDataContainer = document.getElementById('sale-items-data');
    const posForm = document.getElementById('pos-form');
    const scanInput = document.getElementById('scan-input');
    const scanErrorDiv = document.getElementById('scan-error');

    let saleTotal = 0.0;
    let itemCounter = 0; // For unique refs for hidden inputs

    async function loadProductsForCategory(categoryId) {
        // ... (โค้ด loadProductsForCategory เหมือนเดิม) ...
        if (!categoryId) { productGrid.innerHTML = ''; if(productGridPlaceholder) productGridPlaceholder.style.display = 'block'; return; }
        if(productGridPlaceholder) productGridPlaceholder.style.display = 'none';
        productGrid.innerHTML = '<p class="text-muted p-3">กำลังโหลดสินค้า...</p>';
        try {
            const response = await fetch(`/api/products/by-category/${categoryId}/basic`);
            if (!response.ok) throw new Error(`HTTP error! status: ${response.status}`);
            const products = await response.json();
            productGrid.innerHTML = '';
            if (products.length > 0) {
                products.forEach(product => {
                    const card = document.createElement('div'); card.className = 'col';
                    card.innerHTML = `<div class="product-card d-flex flex-column h-100"><div class="product-name">${product.name}</div><div><div class="product-sku">SKU: ${product.sku} ${product.barcode ? `[${product.barcode}]` : ''}</div><div class="product-price">${parseFloat(product.price_b2c || 0).toFixed(2)} บาท</div></div></div>`;
                    card.dataset.productId = product.id; card.dataset.productName = product.name; card.dataset.productSku = product.sku; card.dataset.unitPrice = product.price_b2c || '0'; card.dataset.barcode = product.barcode || '';
                    card.addEventListener('click', handleProductCardClick); productGrid.appendChild(card);
                });
            } else { productGrid.innerHTML = '<p class="text-muted p-3">-- ไม่มีสินค้าในหมวดหมู่นี้ --</p>'; }
        } catch (error) { console.error('Error fetching products:', error); productGrid.innerHTML = '<p class="text-danger p-3">-- เกิดข้อผิดพลาดในการโหลดสินค้า --</p>'; }
    }

    categoryTabs.forEach(tab => {
        tab.addEventListener('shown.bs.tab', function(event) { loadProductsForCategory(event.target.dataset.categoryId); });
    });

    function handleProductCardClick(event) {
        // ... (โค้ด handleProductCardClick เหมือนเดิม, แต่ต้องส่ง barcode ไป addItemToSale) ...
        const card = event.currentTarget;
        const selectedLocation = document.querySelector('input[name="location_id"]:checked');
        if (!selectedLocation) { alert('กรุณาเลือกสถานที่ขายก่อนเพิ่มสินค้า'); return; }
        addItemToSale(card.dataset.productId, card.dataset.productName, card.dataset.productSku, 1, parseFloat(card.dataset.unitPrice), card.dataset.barcode);
    }

    function addItemToSale(productId, productName, productSku, quantity, unitPrice, productBarcode = null) {
        // ... (โค้ด addItemToSale เหมือนเดิม, อาจจะเพิ่มแสดง barcode ในตารางถ้าต้องการ) ...
        const existingRow = saleItemsTableBody.querySelector(`tr[data-product-id="${productId}"]`);
        if (existingRow) {
            const quantityCell = existingRow.cells[1]; const currentItemQuantity = parseInt(quantityCell.textContent); const newQuantity = currentItemQuantity + quantity; quantityCell.textContent = newQuantity;
            const itemTotalPrice = newQuantity * unitPrice; existingRow.cells[3].textContent = itemTotalPrice.toFixed(2);
            const hiddenQtyInput = saleItemsDataContainer.querySelector(`input[name="item_quantity"][data-product-id-ref="${productId}"]`); if(hiddenQtyInput) hiddenQtyInput.value = newQuantity;
        } else {
            const itemTotalPrice = quantity * unitPrice; const currentItemRef = `item_ref_${itemCounter++}`; const newRow = document.createElement('tr'); newRow.dataset.productId = productId; newRow.dataset.itemRef = currentItemRef;
            let displayName = `${productName} (${productSku})`;
            // if (productBarcode && productBarcode !== productSku) { displayName += ` [BC: ${productBarcode}]`; } // Optionally display barcode
            newRow.innerHTML = `<td>${displayName}</td><td class="text-end item-quantity-display">${quantity}</td><td class="text-end">${unitPrice.toFixed(2)}</td><td class="text-end">${itemTotalPrice.toFixed(2)}</td><td class="text-center"><button type="button" class="btn btn-danger btn-sm remove-item-btn" data-item-ref="${currentItemRef}">X</button></td>`;
            saleItemsTableBody.appendChild(newRow);
            const hiddenProductId = document.createElement('input'); hiddenProductId.type = 'hidden'; hiddenProductId.name = 'item_product_id'; hiddenProductId.value = productId; hiddenProductId.dataset.itemRef = currentItemRef; saleItemsDataContainer.appendChild(hiddenProductId);
            const hiddenQuantity = document.createElement('input'); hiddenQuantity.type = 'hidden'; hiddenQuantity.name = 'item_quantity'; hiddenQuantity.value = quantity; hiddenQuantity.dataset.itemRef = currentItemRef; hiddenQuantity.dataset.productIdRef = productId; saleItemsDataContainer.appendChild(hiddenQuantity);
            const hiddenUnitPrice = document.createElement('input'); hiddenUnitPrice.type = 'hidden'; hiddenUnitPrice.name = 'item_unit_price'; hiddenUnitPrice.value = unitPrice.toFixed(2); hiddenUnitPrice.dataset.itemRef = currentItemRef; saleItemsDataContainer.appendChild(hiddenUnitPrice);
        }
        if (noItemsRow) noItemsRow.style.display = 'none';
        updateGrandTotal();
    }

    function updateGrandTotal() { /* ... (เหมือนเดิม) ... */ saleTotal = 0; const rows = saleItemsTableBody.querySelectorAll('tr:not(#no-items-row)'); rows.forEach(row => { const quantity = parseInt(row.cells[1].textContent); const unitPrice = parseFloat(row.cells[2].textContent); if (!isNaN(quantity) && !isNaN(unitPrice)) { saleTotal += quantity * unitPrice; }}); saleTotalElement.textContent = saleTotal.toFixed(2); }
    saleItemsTableBody.addEventListener('click', function(event) { /* ... (เหมือนเดิม) ... */ if (event.target.classList.contains('remove-item-btn')) { const button = event.target; const itemRefToRemove = button.dataset.itemRef; const rowToRemove = saleItemsTableBody.querySelector(`tr[data-item-ref="${itemRefToRemove}"]`); if (rowToRemove) rowToRemove.remove(); saleItemsDataContainer.querySelectorAll(`input[data-item-ref="${itemRefToRemove}"]`).forEach(input => input.remove()); updateGrandTotal(); if (saleItemsTableBody.querySelectorAll('tr:not(#no-items-row)').length === 0 && noItemsRow) { noItemsRow.style.display = ''; } } });

    // Barcode Scan Logic
    if (scanInput) {
        scanInput.addEventListener('keypress', async function(event) {
            if (event.key === 'Enter' || event.keyCode === 13) {
                event.preventDefault();
                const scanCode = this.value.trim();
                if (scanErrorDiv) scanErrorDiv.textContent = '';

                if (scanCode === "") return;

                const selectedLocation = document.querySelector('input[name="location_id"]:checked');
                if (!selectedLocation) {
                    if (scanErrorDiv) scanErrorDiv.textContent = 'กรุณาเลือกสถานที่ขายก่อนสแกนสินค้า';
                    else alert('กรุณาเลือกสถานที่ขายก่อนสแกนสินค้า');
                    this.focus(); return;
                }
                this.disabled = true;
                try {
                    const response = await fetch(`/api/products/lookup-by-scan/${encodeURIComponent(scanCode)}`);
                    const productData = await response.json(); // Attempt to parse JSON regardless of response.ok for now

                    if (response.ok && productData && productData.id) {
                        addItemToSale(
                            productData.id, productData.name, productData.sku,
                            1, parseFloat(productData.price_b2c || 0), productData.barcode
                        );
                        this.value = '';
                    } else {
                        const detail = productData ? productData.detail : (await response.text());
                        if (scanErrorDiv) scanErrorDiv.textContent = `ไม่พบสินค้าสำหรับรหัส: ${scanCode} (หรือเกิดข้อผิดพลาด: ${response.status})`;
                        else alert(`ไม่พบสินค้าสำหรับรหัส: ${scanCode} (หรือเกิดข้อผิดพลาด: ${response.status})`);
                        console.warn("Product not found or error:", response.status, detail);
                    }
                } catch (error) {
                    if (scanErrorDiv) scanErrorDiv.textContent = "เกิดข้อผิดพลาดในการเชื่อมต่อ (Scan)";
                    else alert("เกิดข้อผิดพลาดในการเชื่อมต่อ (Scan)");
                    console.error("Network or other error during scan lookup:", error);
                } finally {
                    this.disabled = false; this.focus();
                }
            }
        });
    }

    posForm.addEventListener('submit', function(event) { /* ... (เหมือนเดิม) ... */ const selectedLocation = document.querySelector('input[name="location_id"]:checked'); if (!selectedLocation) { alert('กรุณาเลือกสถานที่ขาย'); event.preventDefault(); return; } const hiddenItems = saleItemsDataContainer.querySelectorAll('input[name="item_product_id"]'); if (hiddenItems.length === 0) { alert('กรุณาเพิ่มรายการสินค้าอย่างน้อย 1 รายการก่อนบันทึกการขาย'); event.preventDefault(); }});
    document.addEventListener('DOMContentLoaded', function() { /* ... (เหมือนเดิม, รวมถึง scanInput.focus()) ... */ const firstActiveCategoryTab = document.querySelector('.category-tabs .nav-link.active'); if (firstActiveCategoryTab) { loadProductsForCategory(firstActiveCategoryTab.dataset.categoryId); } else if (categoryTabs.length > 0) { new bootstrap.Tab(categoryTabs[0]).show(); } if (scanInput) { scanInput.focus(); } });
</script>
{% endblock %}