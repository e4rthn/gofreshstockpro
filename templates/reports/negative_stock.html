{% raw %}{% extends "base.html" %}

{% block title %}รายงานสต็อกติดลบ - GoFresh StockPro{% endblock %}

{% block head_extra %}
<style>
    .stock-negative {
        color: var(--bs-danger); /* Bootstrap danger color */
        font-weight: bold;
    }
    /* Style for filter section */
    .filter-form-section {
        margin-bottom: 0.5rem;
    }
    .form-select-sm, .btn-sm { /* Make controls smaller */
        font-size: 0.875rem;
    }
    .filter-section {
         margin-bottom: 1.5rem;
         padding: 1rem;
         border: 1px solid #dee2e6;
         border-radius: 0.375rem;
         background-color: #f8f9fa; /* Light background */
    }
</style>
{% endblock %}

{% block content %}
<div class="d-flex justify-content-between align-items-center mb-3">
    <h1><i class="bi bi-exclamation-diamond-fill text-danger me-2"></i>รายงานสต็อกติดลบ</h1>
    {# Optional: Add a refresh button or link back #}
</div>

<div class="filter-section">
    <h5><i class="bi bi-funnel me-1"></i> ตัวกรอง</h5>
    {# --- ฟอร์มสำหรับ Filter --- #}
    {# Use GET method to keep filters in URL #}
    <form id="filterForm" method="get" action="{{ request.app.url_path_for('ui_negative_stock_report') }}">
        <input type="hidden" name="limit" value="{{ limit }}"> {# Keep current limit #}
        {# Page will be reset automatically by create_filter_link logic or set to 1 here #}
        <input type="hidden" name="page" value="1">

        <div class="row g-2 align-items-end">
            {# Location Filter Dropdown #}
            <div class="col-md-4 filter-form-section">
                <label for="location_filter" class="form-label">สถานที่จัดเก็บ:</label>
                <select class="form-select form-select-sm" id="location_filter" name="location" onchange="document.getElementById('filterForm').submit();">
                    <option value="">-- ทุกสถานที่ --</option>
                    {% for loc in all_locations %}
                        <option value="{{ loc.id }}" {% if selected_location_id and selected_location_id|string == loc.id|string %}selected{% endif %}>
                            {{ loc.name }}
                        </option>
                    {% endfor %}
                </select>
            </div>

            {# Category Filter Dropdown #}
            <div class="col-md-4 filter-form-section">
                <label for="category_filter" class="form-label">หมวดหมู่:</label>
                <select class="form-select form-select-sm" id="category_filter" name="category" onchange="document.getElementById('filterForm').submit();">
                    <option value="">-- ทุกหมวดหมู่ --</option>
                    {% for cat in all_categories %}
                        <option value="{{ cat.id }}" {% if selected_category_id and selected_category_id|string == cat.id|string %}selected{% endif %}>
                            {{ cat.name }}
                        </option>
                    {% endfor %}
                </select>
            </div>

            {# Clear Filter Button #}
            <div class="col-md-auto filter-form-section">
                 {# Link generated by the helper function passed from the route #}
                 <a href="{{ create_filter_link(location=None, category=None, limit=limit, page=1) }}" class="btn btn-outline-secondary btn-sm">ล้างตัวกรอง</a>
            </div>
        </div>
    </form>
    {# -------------------------- #}
</div>


{# --- Display Count and Pagination Info --- #}
{% if total_count > 0 %}
<p>
    พบสินค้าสต็อกติดลบทั้งหมด {{ total_count }} รายการ
    {% if selected_location_id %}{% for loc in all_locations %}{% if loc.id|string == selected_location_id|string %} ใน <strong>{{ loc.name }}</strong>{% endif %}{% endfor %}{% endif %}
    {% if selected_category_id %}{% for cat in all_categories %}{% if cat.id|string == selected_category_id|string %} ประเภท <strong>{{ cat.name }}</strong>{% endif %}{% endfor %}
    (หน้าที่ {{ page }} / {{ total_pages }})
</p>
{% elif selected_location_id or selected_category_id %}
<p class="text-muted mt-3">ไม่พบข้อมูลสต็อกติดลบตามเงื่อนไขที่เลือก</p>
{% else %}
<p class="text-success mt-3"><i class="bi bi-check-circle-fill me-1"></i>ยอดเยี่ยม! ไม่พบสินค้าสต็อกติดลบในระบบขณะนี้</p>
{% endif %}
{# --------------------------------------- #}


{# --- Table to Display Negative Stock Items --- #}
{% if negative_stock_items %} {# Use the variable name passed from the route context #}
<div class="table-responsive">
    <table class="table table-striped table-hover table-sm">
        <thead class="table-light">
            <tr>
                <th>สถานที่จัดเก็บ</th>
                <th>ชื่อสินค้า</th>
                <th>SKU</th>
                <th>หมวดหมู่</th>
                <th class="text-end">จำนวนคงเหลือ</th>
                <th>อัปเดตล่าสุด</th>
                <th>ดำเนินการ</th> {# Optional: Add action column #}
            </tr>
        </thead>
        <tbody>
            {% for item in negative_stock_items %} {# Loop through the items #}
            <tr>
                {# Access related data loaded by joinedload #}
                <td>{{ item.location.name if item.location else 'N/A' }}</td>
                <td>{{ item.product.name if item.product else 'N/A' }}</td>
                <td>{{ item.product.sku if item.product else 'N/A' }}</td>
                <td>{{ item.product.category.name if item.product and item.product.category else 'N/A' }}</td>
                <td class="text-end stock-negative"> {# Apply negative stock style #}
                    {{ item.quantity }}
                </td>
                <td>{{ item.last_updated.strftime('%Y-%m-%d %H:%M') if item.last_updated else '-'}}</td>
                <td>
                    {# Example Actions: Link to adjust stock for this item/location #}
                    <a href="{{ request.app.url_path_for('ui_show_adjustment_form') }}?product_id={{ item.product_id }}&location_id={{ item.location_id }}"
                       class="btn btn-warning btn-sm" title="ปรับปรุงสต็อกรายการนี้">
                       <i class="bi bi-pencil-square"></i> ปรับปรุง
                    </a>
                     {# You might add other actions, e.g., view transaction history #}
                </td>
            </tr>
            {% endfor %}
        </tbody>
    </table>
</div>
{% endif %}
{# --------------------------------------------- #}


{# --- Pagination --- #}
{% if total_pages > 1 %}
<div class="mt-4 d-flex justify-content-center">
    {# Ensure the necessary variables (request, page, total_pages, create_filter_link) are passed #}
    {% include '_pagination.html' %}
</div>
{% endif %}
{# ---------------- #}

{% endblock %}{% endraw %}